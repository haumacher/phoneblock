CREATE TABLE PROPERTIES (
	NAME CHARACTER VARYING(255) NOT NULL,
	VAL CHARACTER VARYING(1024) NOT NULL,
	CONSTRAINT PROPERTIES_PK PRIMARY KEY (NAME)
);

INSERT INTO PROPERTIES (NAME, VAL) VALUES('db.version', '10');


CREATE TABLE BLOCKLIST (
	OWNER BIGINT NOT NULL,
	PHONE CHARACTER VARYING(100) NOT NULL,

	CONSTRAINT BLOCKLIST_PK PRIMARY KEY (OWNER,PHONE)
);

CREATE TABLE EXCLUDES (
	OWNER BIGINT NOT NULL,
	PHONE CHARACTER VARYING(100) NOT NULL,

	CONSTRAINT EXCLUDES_PK PRIMARY KEY (OWNER,PHONE)
);

CREATE TABLE SPAMREPORTS (
	PHONE VARCHAR(100) NOT NULL,
	VOTES INTEGER DEFAULT 1 NOT NULL,
	LASTUPDATE BIGINT NOT NULL,
	DATEADDED BIGINT DEFAULT 0 NOT NULL,

	CONSTRAINT SPAMREPORTS_PK PRIMARY KEY (PHONE)
);

CREATE TABLE NUMBERS (
	PHONE CHARACTER VARYING(100) NOT NULL,
	SHA1 BINARY VARYING(20),
	ADDED BIGINT DEFAULT 0 NOT NULL,
	UPDATED BIGINT DEFAULT 0 NOT NULL,
	LASTSEARCH BIGINT DEFAULT 0 NOT NULL,
	LASTPING BIGINT DEFAULT 0 NOT NULL,
	LASTMETA BIGINT DEFAULT 0 NOT NULL,
	ACTIVE BOOLEAN DEFAULT TRUE NOT NULL,
	CALLS INTEGER DEFAULT 0 NOT NULL,
	VOTES INTEGER DEFAULT 0 NOT NULL,
	DOWN_VOTES INTEGER DEFAULT 0 NOT NULL,
	UP_VOTES INTEGER DEFAULT 0 NOT NULL,
	LEGITIMATE INTEGER DEFAULT 0 NOT NULL,
	PING INTEGER DEFAULT 0 NOT NULL,
	POLL INTEGER DEFAULT 0 NOT NULL,
	ADVERTISING INTEGER DEFAULT 0 NOT NULL,
	GAMBLE INTEGER DEFAULT 0 NOT NULL,
	FRAUD INTEGER DEFAULT 0 NOT NULL,
	SEARCHES INTEGER DEFAULT 0 NOT NULL,
	SEARCHES_CURRENT INTEGER DEFAULT 0 NOT NULL,
	SEARCHES_BACKUP INTEGER DEFAULT 0 NOT NULL,
	CONSTRAINT NUMBERS_PK PRIMARY KEY (PHONE)
);

CREATE INDEX NUMBERS_SHA1_IDX ON NUMBERS (SHA1, PHONE);
CREATE INDEX NUMBERS_ACTIVE_IDX ON NUMBERS (ACTIVE DESC,VOTES DESC);
CREATE INDEX NUMBERS_UPDATED_IDX ON NUMBERS (UPDATED DESC);
CREATE INDEX NUMBERS_SEARCHES_IDX ON NUMBERS (SEARCHES DESC);
CREATE INDEX NUMBERS_SEARCHES_CURRENT_IDX ON NUMBERS (SEARCHES_CURRENT DESC);

CREATE TABLE NUMBERS_LOCALE (
	PHONE CHARACTER VARYING(100) NOT NULL,
	DIAL CHARACTER VARYING(8) NOT NULL,
	LASTACCESS BIGINT NOT NULL,
	SEARCHES INTEGER DEFAULT 0 NOT NULL,
	VOTES INTEGER DEFAULT 0 NOT NULL,
	CALLS INTEGER DEFAULT 0 NOT NULL,
	CONSTRAINT NUMBERS_LOCALE_PK PRIMARY KEY (PHONE,DIAL)
);

CREATE TABLE REVISION (
	ID INTEGER GENERATED ALWAYS AS IDENTITY,
	CREATED BIGINT NOT NULL,
	CONSTRAINT REVISION_PK PRIMARY KEY (ID)
);

CREATE TABLE NUMBERS_HISTORY (
	RMIN INTEGER NOT NULL,
	RMAX INTEGER NOT NULL,
	PHONE CHARACTER VARYING(100) NOT NULL,
	ACTIVE BOOLEAN DEFAULT TRUE NOT NULL,
	CALLS INTEGER DEFAULT 0 NOT NULL,
	VOTES INTEGER DEFAULT 0 NOT NULL,
	DOWN_VOTES INTEGER DEFAULT 0 NOT NULL,
	UP_VOTES INTEGER DEFAULT 0 NOT NULL,
	LEGITIMATE INTEGER DEFAULT 0 NOT NULL,
	PING INTEGER DEFAULT 0 NOT NULL,
	POLL INTEGER DEFAULT 0 NOT NULL,
	ADVERTISING INTEGER DEFAULT 0 NOT NULL,
	GAMBLE INTEGER DEFAULT 0 NOT NULL,
	FRAUD INTEGER DEFAULT 0 NOT NULL,
	SEARCHES INTEGER DEFAULT 0 NOT NULL,
	CONSTRAINT NUMBERS_HISTORY_PK PRIMARY KEY (RMAX,PHONE)
);

CREATE TABLE NUMBERS_AGGREGATION_10 (
	PREFIX CHARACTER VARYING(100) NOT NULL,
	CNT INTEGER NOT NULL,
	VOTES INTEGER NOT NULL,
	CONSTRAINT NUMBERS_AGGREGATION_10_PK PRIMARY KEY (PREFIX)
);

CREATE TABLE NUMBERS_AGGREGATION_100 (
	PREFIX CHARACTER VARYING(100) NOT NULL,
	CNT INTEGER NOT NULL,
	VOTES INTEGER NOT NULL,
	CONSTRAINT NUMBERS_AGGREGATION_100_PK PRIMARY KEY (PREFIX)
);

CREATE TABLE OLDREPORTS (
	PHONE VARCHAR(100) NOT NULL,
	VOTES INTEGER DEFAULT 1 NOT NULL,
	LASTUPDATE BIGINT NOT NULL,
	DATEADDED BIGINT DEFAULT 0 NOT NULL,

	CONSTRAINT OLDREPORTS_PK PRIMARY KEY (PHONE)
);

CREATE TABLE WHITELIST (
	PHONE CHARACTER VARYING(100) NOT NULL,

	CONSTRAINT WHITELIST_PK PRIMARY KEY (PHONE)
);

CREATE TABLE USERS (
	ID BIGINT NOT NULL AUTO_INCREMENT,

	LOGIN CHARACTER VARYING(255) NOT NULL,
	PWHASH BINARY VARYING(128) NOT NULL,

	CLIENTNAME CHARACTER VARYING(64) NULL,
	EXTID CHARACTER VARYING(64) NULL,
	GOOGLEID CHARACTER VARYING(64) NULL,

	DISPLAYNAME CHARACTER VARYING(255) NOT NULL,
	EMAIL CHARACTER VARYING(255),
	LASTACCESS BIGINT DEFAULT 0 NOT NULL,
	REGISTERED BIGINT DEFAULT 0 NOT NULL,
	MIN_VOTES INTEGER DEFAULT 4 NOT NULL,
	MAX_LENGTH INTEGER DEFAULT 1800 NOT NULL,
	USERAGENT CHARACTER VARYING(512) DEFAULT NULL,
	LOCALE CHARACTER VARYING(16) DEFAULT 'de' NOT NULL,
	DIAL CHARACTER VARYING(8) DEFAULT '+49' NOT NULL,
	NATIONAL BOOLEAN DEFAULT 0 NOT NULL,

	NOTIFIED BOOLEAN DEFAULT 0 NOT NULL,
	WILDCARDS BOOLEAN DEFAULT 1 NOT NULL,
	WELCOME BOOLEAN DEFAULT FALSE NOT NULL,

	CREDIT INTEGER DEFAULT 0 NOT NULL,
	CONSTRAINT USERS_PK PRIMARY KEY (ID)
);

CREATE UNIQUE INDEX USERS_UN_INDEX_4 ON USERS (LOGIN);
CREATE INDEX USERS_EMAIL_INDEX ON USERS (EMAIL);
CREATE INDEX USERS_GOOGLEID_IDX ON USERS (GOOGLEID);


CREATE TABLE CONTRIBUTIONS (
	ID BIGINT NOT NULL AUTO_INCREMENT,
	USER_ID BIGINT,
	SENDER CHARACTER VARYING(255),
	TX CHARACTER VARYING(100) NOT NULL,
	AMOUNT INTEGER NOT NULL,
	MESSAGE CHARACTER VARYING(1024),
	RECEIVED BIGINT DEFAULT 0 NOT NULL,
	ACK BOOLEAN DEFAULT FALSE NOT NULL,
	CONSTRAINT CONTRIBUTIONS_PK PRIMARY KEY (ID)
);
CREATE INDEX CONTRIBUTIONS_USERS_FK_INDEX_2 ON CONTRIBUTIONS (USER_ID);
CREATE UNIQUE INDEX CONTRIBUTIONS_TX_IDX ON CONTRIBUTIONS (TX);
ALTER TABLE CONTRIBUTIONS ADD CONSTRAINT CONTRIBUTIONS_USERS_FK FOREIGN KEY (USER_ID) REFERENCES USERS(ID) ON DELETE SET NULL ON UPDATE RESTRICT;

CREATE TABLE TOKENS (
	ID BIGINT NOT NULL AUTO_INCREMENT,
	USERID BIGINT NOT NULL,
	CREATED BIGINT DEFAULT 0 NOT NULL,
	PWHASH BINARY VARYING(128) NOT NULL,
	LABEL CHARACTER VARYING(1024),
	IMPLICIT BOOLEAN DEFAULT false NOT NULL,
	ACCESS_QUERY BOOLEAN DEFAULT false NOT NULL,
	ACCESS_DOWNLOAD BOOLEAN DEFAULT false NOT NULL,
	ACCESS_CARDDAV BOOLEAN DEFAULT false NOT NULL,
	ACCESS_RATE BOOLEAN DEFAULT false NOT NULL,
	ACCESS_LOGIN BOOLEAN DEFAULT false NOT NULL,
	LASTACCESS BIGINT DEFAULT 0 NOT NULL,
	USERAGENT CHARACTER VARYING(512) NOT NULL,
	CONSTRAINT TOKENS_PK PRIMARY KEY (ID)
);

ALTER TABLE TOKENS ADD CONSTRAINT TOKENS_USERS_FK FOREIGN KEY (USERID) REFERENCES USERS(ID) ON DELETE CASCADE;
CREATE INDEX TOKENS_USERID_IDX ON TOKENS (USERID,IMPLICIT DESC,LASTACCESS DESC,ID);

CREATE TABLE PERSONALIZATION (
	USERID BIGINT NOT NULL,
	PHONE CHARACTER VARYING(100) NOT NULL,
	BLOCKED BOOLEAN DEFAULT true NOT NULL,
	CONSTRAINT PERSONALIZATION_PK PRIMARY KEY (USERID,PHONE)
);

CREATE INDEX PERSONALIZATION_USERID_IDX ON PERSONALIZATION (USERID,BLOCKED DESC,PHONE);

CREATE TABLE ANSWERBOT_SIP (
	ID BIGINT NOT NULL AUTO_INCREMENT,
	USERNAME CHARACTER VARYING(64) NOT NULL,
	PASSWD CHARACTER VARYING(64) NOT NULL,
	USERID BIGINT NOT NULL,
	CREATED BIGINT DEFAULT 0 NOT NULL,
	UPDATED BIGINT DEFAULT 0 NOT NULL,
	LAST_SUCCESS BIGINT DEFAULT 0 NOT NULL,
	ENABLED BOOLEAN DEFAULT FALSE NOT NULL,
	HOST CHARACTER VARYING(64),
	PREFER_V4 BOOLEAN DEFAULT FALSE NOT NULL,
	REGISTRAR CHARACTER VARYING(64) DEFAULT 'fritz.box' NOT NULL,
	REALM CHARACTER VARYING(64) DEFAULT 'fritz.box' NOT NULL,
	REGISTERED BOOLEAN DEFAULT FALSE NOT NULL,
	REGISTER_MSG CHARACTER VARYING(256),
	NEW_CALLS INTEGER DEFAULT 0 NOT NULL,
	CALLS_ACCEPTED INTEGER DEFAULT 0 NOT NULL,
	TALK_TIME BIGINT DEFAULT 0 NOT NULL,
	MIN_VOTES INTEGER DEFAULT 4 NOT NULL,
	WILDCARDS BOOLEAN DEFAULT true NOT NULL,
	COLUMN RETENTION_PERIOD VARCHAR(10) DEFAULT 'NEVER',
	CONSTRAINT ANSWERBOT_SIP_PK PRIMARY KEY (ID),
	CONSTRAINT ANSWERBOT_SIP_UN UNIQUE (USERNAME),
	CONSTRAINT ANSWERBOT_SIP_FK FOREIGN KEY (USERID) REFERENCES USERS(ID) ON DELETE CASCADE ON UPDATE RESTRICT
);

-- Create index for efficient retention cleanup queries
CREATE INDEX ANSWERBOT_RETENTION_IDX
ON ANSWERBOT_SIP (RETENTION_PERIOD);

-- Create index for efficient call cleanup by timestamp
CREATE INDEX ANSWERBOT_CALLS_STARTED_IDX
ON ANSWERBOT_CALLS (ABID, STARTED);

CREATE TABLE ANSWERBOT_CALLS (
	ID BIGINT NOT NULL AUTO_INCREMENT,
	ABID BIGINT NOT NULL,
	CALLER CHARACTER VARYING(100) NOT NULL,
	STARTED BIGINT NOT NULL,
	DURATION BIGINT NOT NULL,
	CONSTRAINT ANSWERBOT_CALLS_FK FOREIGN KEY (ABID) REFERENCES ANSWERBOT_SIP(ID) ON DELETE CASCADE ON UPDATE RESTRICT
);


CREATE TABLE ANSWERBOT_DYNDNS (
	DYNDNS_USER CHARACTER VARYING(64) NOT NULL,
	DYNDNS_PASSWD CHARACTER VARYING(64) NOT NULL,
	USERID BIGINT NOT NULL,
	ABID BIGINT DEFAULT 0 NOT NULL,
	CREATED BIGINT DEFAULT 0 NOT NULL,
	UPDATED BIGINT DEFAULT 0 NOT NULL,
	IP4 CHARACTER VARYING(64) DEFAULT '' NOT NULL,
	IP6 CHARACTER VARYING(64) DEFAULT '' NOT NULL,
	CONSTRAINT ANSWERBOT_DYNDNS_PK PRIMARY KEY (DYNDNS_USER),
	CONSTRAINT ANSWERBOT_DYNDNS_FK_1 FOREIGN KEY (USERID) REFERENCES USERS(ID) ON DELETE CASCADE ON UPDATE RESTRICT,
	CONSTRAINT ANSWERBOT_DYNDNS_FK_2 FOREIGN KEY (ABID) REFERENCES ANSWERBOT_SIP(ID) ON DELETE CASCADE ON UPDATE RESTRICT
);


CREATE TABLE CALLREPORT (
	USERID BIGINT NOT NULL,
	LASTID CHARACTER VARYING(64) NOT NULL,
	"TIMESTAMP" CHARACTER VARYING(64) NOT NULL,
	LASTACCESS BIGINT NOT NULL,

	CONSTRAINT CALLREPORT_PK PRIMARY KEY (USERID)
);

CREATE TABLE CALLERS (
	USERID BIGINT NOT NULL,
	PHONE CHARACTER VARYING(100) NOT NULL,
	CALLS INTEGER DEFAULT 0 NOT NULL,
	LASTUPDATE BIGINT NOT NULL,

	CONSTRAINT CALLERS_PK PRIMARY KEY (USERID,PHONE)
);

CREATE TABLE RATINGS (
	PHONE CHARACTER VARYING(100) NOT NULL,
	RATING CHARACTER VARYING(15) NOT NULL,
	COUNT INTEGER DEFAULT 0 NOT NULL,
	LASTUPDATE BIGINT DEFAULT 0 NOT NULL,
	BACKUP INTEGER DEFAULT 0 NOT NULL,

	CONSTRAINT RATINGS_PK PRIMARY KEY (PHONE,RATING)
);

CREATE TABLE RATINGHISTORY (
	REV INTEGER NOT NULL,
	PHONE CHARACTER VARYING(100) NOT NULL,
	RATING CHARACTER VARYING(15) NOT NULL,
	COUNT INTEGER DEFAULT 1 NOT NULL,

	CONSTRAINT RATINGHISTORY_PK PRIMARY KEY (REV,PHONE,RATING)
);

CREATE TABLE COMMENTS (
	ID VARCHAR(64) NOT NULL,

	PHONE CHARACTER VARYING(100) NOT NULL,
	RATING CHARACTER VARYING(15) NOT NULL,
	COMMENT CHARACTER VARYING(8192) NULL,
	SERVICE CHARACTER VARYING(30) NULL,
	CREATED BIGINT NOT NULL,
	UP INTEGER DEFAULT 0 NOT NULL,
	DOWN INTEGER DEFAULT 0 NOT NULL,
	USERID BIGINT,
	LOCALE CHARACTER VARYING(16) DEFAULT 'de' NOT NULL,

	CONSTRAINT COMMENTS_PK PRIMARY KEY (ID)
);
CREATE INDEX COMMENTS_PHONE_IDX ON COMMENTS (PHONE,CREATED);
CREATE INDEX COMMENTS_USER_PHONE_IDX ON COMMENTS (USERID, PHONE);

CREATE TABLE SEARCHES (
	PHONE CHARACTER VARYING(100) NOT NULL,
	COUNT INTEGER DEFAULT 1 NOT NULL,
	LASTUPDATE BIGINT NOT NULL,
	BACKUP INTEGER DEFAULT 0 NOT NULL,

	CONSTRAINT SEARCHES_PK PRIMARY KEY (PHONE)
);

CREATE TABLE SUMMARY_REQUEST (
	PHONE CHARACTER VARYING(100) NOT NULL,
	PRIORITY INTEGER NOT NULL AUTO_INCREMENT,
	CONSTRAINT SUMMARY_REQUEST_PK PRIMARY KEY (PHONE)
);
CREATE INDEX SUMMARY_REQUEST_PRIORITY_IDX ON SUMMARY_REQUEST (PRIORITY);

CREATE TABLE SUMMARY (
	PHONE CHARACTER VARYING(100) NOT NULL,
	COMMENT CHARACTER VARYING(4096) NOT NULL,
	CREATED BIGINT NOT NULL,
	CONSTRAINT SUMMARY_PK PRIMARY KEY (PHONE)
);

CREATE TABLE DOMAIN_CHECK (
	DOMAIN_NAME CHARACTER VARYING(255) NOT NULL,
	DISPOSABLE BOOLEAN NOT NULL,
	LAST_CHANGED BIGINT NOT NULL,
	SOURCE_SYSTEM INTEGER NOT NULL,
	MX_HOST CHARACTER VARYING(255),
	MX_IP CHARACTER VARYING(255),
	CONSTRAINT DOMAIN_CHECK_PK PRIMARY KEY (DOMAIN_NAME)
);
